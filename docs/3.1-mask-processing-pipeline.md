# Phase 3.1: Mask Processing Pipeline

**Status**: ✅ COMPLETE

## Overview

The mask processing pipeline transforms rendered map layer images into watercolor-style masks with organic, hand-painted edges. This is the core of the watercolor effect.

## Implementation

**Location**: [`internal/mask/processor.go`](../internal/mask/processor.go)

**Tests**: [`internal/mask/processor_test.go`](../internal/mask/processor_test.go)

**Test Coverage**: 100.0%

## Functions

### 1. ExtractBinaryMask

```go
func ExtractBinaryMask(img image.Image) *image.Gray
```

Converts a colored layer image into a binary mask:

- Transparent pixels (alpha = 0) → Black (0)
- Non-transparent pixels (alpha > 0) → White (255)

**Use case**: Extract feature boundaries from Mapnik-rendered layers.

### 2. GaussianBlur

```go
func GaussianBlur(mask *image.Gray, sigma float32) *image.Gray
```

Applies Gaussian blur to soften mask edges.

**Parameters**:

- `sigma`: Blur radius (typical: 1.0 - 3.0)

**Library**: Uses `github.com/disintegration/gift` for high-quality blur.

### 3. GeneratePerlinNoise

```go
func GeneratePerlinNoise(width, height int, scale float64, seed int64) *image.Gray
```

Generates deterministic Perlin noise texture.

**Parameters**:

- `width, height`: Texture dimensions
- `scale`: Frequency control (smaller = more detail, typical: 30-100)
- `seed`: Random seed for reproducibility

**Library**: Uses `github.com/aquilax/go-perlin` for noise generation.

**Output**: Grayscale image with values 0-255, smooth continuous noise pattern.

### 4. ApplyNoiseToMask

```go
func ApplyNoiseToMask(mask, noise *image.Gray, strength float64) *image.Gray
```

Overlays Perlin noise onto a blurred mask to create organic edges.

**Parameters**:

- `mask`: Blurred binary mask
- `noise`: Perlin noise texture
- `strength`: How much noise to apply (typical: 0.2 - 0.5)

**Algorithm**:

- Noise values are centered around 128
- Delta = (noiseValue - 128) × strength
- Result = clamp(maskValue + delta, 0, 255)

### 5. ApplyThreshold

```go
func ApplyThreshold(mask *image.Gray, threshold uint8) *image.Gray
```

Applies binary threshold to sharpen mask edges after noise.

**Parameters**:

- `threshold`: Cutoff value (typical: 128)

**Output**:

- Values below threshold → 0 (black)
- Values >= threshold → 255 (white)

### 6. AntialiasEdges

```go
func AntialiasEdges(mask *image.Gray, sigma float32) *image.Gray
```

Applies subtle antialiasing to smooth sharp edges after thresholding.

**Parameters**:

- `sigma`: Very light blur (typical: 0.3 - 0.7)

**Implementation**: Wrapper around GaussianBlur with small sigma.

## Complete Pipeline Workflow

```
Rendered Layer (RGBA)
    ↓
1. ExtractBinaryMask
    ↓
Binary Mask (sharp edges)
    ↓
2. GaussianBlur (sigma=2.0)
    ↓
Softened Mask
    ↓
3. GeneratePerlinNoise (scale=30, seed)
    ↓
Noise Texture
    ↓
4. ApplyNoiseToMask (strength=0.3)
    ↓
Noisy Mask (organic variation)
    ↓
5. ApplyThreshold (threshold=128)
    ↓
Re-sharpened Binary Mask
    ↓
6. AntialiasEdges (sigma=0.5)
    ↓
Final Watercolor Mask
```

## Typical Parameters

For standard watercolor effect:

```go
mask := ExtractBinaryMask(layerImage)
blurred := GaussianBlur(mask, 2.0)
noise := GeneratePerlinNoise(256, 256, 30.0, seed)
noisy := ApplyNoiseToMask(blurred, noise, 0.3)
thresholded := ApplyThreshold(noisy, 128)
final := AntialiasEdges(thresholded, 0.5)

// Current defaults are slightly softer/smoother:
// - blur sigma: 1.8
// - noise strength: 0.28
// - antialias sigma: 0.6
```

## Test Results

All 7 tests passing:

1. ✅ **TestExtractBinaryMask**: Binary mask extraction from colored layers
2. ✅ **TestGaussianBlur**: Edge softening with Gaussian filter
3. ✅ **TestGeneratePerlinNoise**: Deterministic noise generation with variation
4. ✅ **TestApplyNoiseToMask**: Noise overlay preserves dark/bright areas
5. ✅ **TestApplyThreshold**: Sharp binary thresholding
6. ✅ **TestAntialiasEdges**: Subtle edge smoothing
7. ✅ **TestWatercolorPipeline**: Full integration test with circular feature

## Visual Effect

The pipeline creates:

- **Organic edges**: Not perfectly circular or straight
- **Hand-painted look**: Natural variation from Perlin noise
- **Soft transitions**: Antialiasing prevents jagged edges
- **Controlled randomness**: Deterministic seed ensures tile consistency

## Dependencies

```go
import (
    "github.com/disintegration/gift"  // Image filters
    "github.com/aquilax/go-perlin"    // Perlin noise
)
```

## Next Steps

- **Phase 3.2**: Noise consistency across tile boundaries
- **Phase 3.3**: Apply textures using the processed masks
- **Phase 3.4**: Edge darkening effect for depth
