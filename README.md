# WaterColorMap

Generate Stamen Watercolor–style raster map tiles from OpenStreetMap data — with multi-pass rendering, mask processing, watercolor textures, and seamless compositing.

**[Live Demo](https://meko-christian.github.io/WaterColorMap/)**

WaterColorMap is built for "old-school" raster cartography: we render clean layer masks (Mapnik), distort edges organically (blur + deterministic Perlin noise + threshold), apply seamless watercolor textures, then composite everything into final web-ready tiles.

## Highlights

- Full watercolor tile pipeline (render → masks → textures → composite)
- Deterministic edges across tile boundaries (no seams)
- Multi-pass Mapnik rendering for clean layer isolation
- Built-in textures and Mapnik styles (land/water/parks/civic/roads)
- Fast batch generation with safe caching and `--force` regeneration
- Docker and native Linux workflows

## Requirements

- Linux (tested on Ubuntu 24.04)
- Go 1.25+
- Mapnik 3.1+ (`libmapnik-dev`, `mapnik-utils`, `python3-mapnik`)
- Build tooling: `pkg-config`, `build-essential`
- Optional: [Just](https://github.com/casey/just) for one-liner workflows

## Quick Start (native)

```bash
git clone https://github.com/MeKo-Tech/watercolormap.git
cd watercolormap

sudo apt update
sudo apt install -y libmapnik-dev mapnik-utils python3-mapnik build-essential pkg-config

cp config.example.yaml config.yaml
just build

# Generate a single tile (Hanover example)
./bin/watercolormap generate --tile z13_x4297_y2754
```

More setup details (including troubleshooting) are in [SETUP.md](SETUP.md).

## Quick Start (Docker)

```bash
cp config.example.yaml config.yaml
just docker-build

docker run --rm \
  -v "$PWD/config.yaml:/app/config.yaml:ro" \
  -v "$PWD/tiles:/app/tiles" \
  -v "$PWD/cache:/app/cache" \
  -v "$PWD/assets:/app/assets:ro" \
  -e WATERCOLORMAP_CONFIG=/app/config.yaml \
  watercolormap:latest generate --tile z13_x4297_y2754
```

## Usage

### Generate tiles

Generate a single tile:

```bash
watercolormap generate --tile z13_x4297_y2754
```

Generate a tile using explicit coordinates:

```bash
watercolormap generate --zoom 13 --x 4297 --y 2754
```

Generate a batch for a bounding box / zoom range (see `watercolormap generate --help` for the exact flags supported by your build):

```bash
watercolormap generate --min-zoom 10 --max-zoom 16 --bounds "9.60,52.30,9.90,52.50"
```

### Serve tiles in Leaflet

WaterColorMap can generate static PNG tiles; you can serve them with any web server and view them in Leaflet.

If you serve the `tiles/` folder (for example with `python3 -m http.server 8000` from the repo root), you can point Leaflet at the default flat file naming scheme (`z{z}_x{x}_y{y}.png`) like this:

```js
const layer = L.tileLayer("", {
  maxZoom: 16,
  attribution: "© OpenStreetMap contributors",
});

layer.getTileUrl = ({ x, y, z }) =>
  `http://localhost:8000/tiles/z${z}_x${x}_y${y}.png`;
layer.addTo(map);
```

## Browser Playground (WASM)

There is a minimal browser playground (Leaflet + IndexedDB cache) that can be deployed via GitHub Pages.

- Live (GitHub Pages): https://meko-christian.github.io/WaterColorMap/wasm-playground/
- Local (build + serve):

```bash
just build-wasm-local
# open http://localhost:8000/wasm-playground/
```

Note: in-browser rendering is limited because Mapnik is a native dependency; for on-demand tile generation, run the backend server locally:

```bash
./bin/watercolormap serve --addr 127.0.0.1:8080
```

## Output layout

By default, tiles are written to `./tiles` as PNG files using the naming scheme:

```text
tiles/
  z13_x4297_y2754.png
  z13_x4297_y2754@2x.png        # optional HiDPI output

HiDPI (`@2x`) tiles are generated by passing `--hidpi` to `watercolormap generate`.
PNG encoding can be tuned via `--png-compression` (`default`, `speed`, `best`, `none`).
```

During generation, intermediate layer renders and processed masks may be stored in the cache directory for debugging and faster incremental builds.

## How it works (pipeline)

1. Fetch OSM features for the requested tile (Overpass API)
2. Convert features to GeoJSON per layer (land/water/parks/civic/roads)
3. Render each layer via Mapnik to a clean RGBA mask image (multi-pass)
4. Convert layer images to binary masks and apply the watercolor mask pipeline:
   - Gaussian blur
   - deterministic Perlin noise overlay
   - thresholding + antialias
5. Apply seamless watercolor textures as alpha-masked fills
6. Composite layers in the correct order into a final tile

Mask processing details: [docs/3.1-mask-processing-pipeline.md](docs/3.1-mask-processing-pipeline.md)

## Configuration

Configuration is loaded from:

1. `--config` (defaults to `./config.yaml`)
2. Environment variables (`WATERCOLORMAP_…`)
3. CLI flags

Start with the example file: [config.example.yaml](config.example.yaml)

Key options:

- `data-source`: OSM data source (default: `overpass`)
- `output-dir`: where generated tiles go
- `overpass.*`: endpoint, rate limiting, retry/backoff
- `tile.*`: size, format, DPI, cache settings
- `rendering.*`: layer order, texture mapping, fallback colors

## Development

```bash
just build
just test
just fmt
just lint
just check
```

## Project layout

```text
cmd/watercolormap/              # CLI entry
internal/datasource/            # OSM/Overpass fetching
internal/geojson/               # OSM features → GeoJSON
internal/renderer/              # Mapnik rendering + multi-pass
internal/mask/                  # Watercolor mask processing
internal/tile/                  # z/x/y math + bounds
assets/styles/                  # Mapnik styles
assets/textures/                # Seamless watercolor textures
docs/                           # Design notes and phase docs
```

## Attribution

- Map data: © OpenStreetMap contributors
- Watercolor inspiration: Stamen Design's "Watercolor" process and textures writeups

## License

MIT License — see [LICENSE](LICENSE) for details.
